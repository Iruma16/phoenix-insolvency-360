[pytest]
# ═══════════════════════════════════════════════════════════════════════════════
# PYTEST CONFIGURATION - PHOENIX LEGAL v2.0
# ═══════════════════════════════════════════════════════════════════════════════

# Directorios de tests
testpaths = tests

# Patrones de archivos
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# ───────────────────────────────────────────────────────────────────────────────
# MARKERS - Clasificación de Tests
# ───────────────────────────────────────────────────────────────────────────────
markers =
    unit: Tests unitarios rápidos (< 1s)
    integration: Tests de integración (con dependencias externas)
    e2e: Tests end-to-end completos
    slow: Tests lentos (> 10s)
    llm: Tests que requieren LLM real (API key)
    smoke: Tests de humo (verificación básica)
    rag: Tests relacionados con RAG
    db: Tests que requieren base de datos
    api: Tests de API REST
    security: Tests de seguridad
    performance: Tests de rendimiento
    deterministic: Tests completamente deterministas
    validation: Tests de validación (contratos, invariantes, smoke de parser)

# ───────────────────────────────────────────────────────────────────────────────
# OPCIONES POR DEFECTO
# ───────────────────────────────────────────────────────────────────────────────
addopts = 
    # Verbosidad y formato
    -v
    --tb=short
    --strict-markers
    --disable-warnings
    
    # Excluir tests lentos por defecto
    -m "not llm and not slow"
    
    # Ignorar directorios
    --ignore=papelera
    --ignore=.venv
    --ignore=venv
    
    # Cobertura de código
    --cov=app
    --cov-report=html:tests/coverage_html
    --cov-report=term-missing:skip-covered
    --cov-report=xml:tests/coverage.xml
    --cov-fail-under=0
    
    # JUnit XML para CI/CD
    --junit-xml=tests/report_junit.xml
    
    # Warnings
    -W ignore::DeprecationWarning
    -W ignore::PendingDeprecationWarning

# Output
console_output_style = progress

# ───────────────────────────────────────────────────────────────────────────────
# CONFIGURACIÓN DE COBERTURA
# ───────────────────────────────────────────────────────────────────────────────
[coverage:run]
source = app
omit = 
    */tests/*
    */test_*.py
    */__pycache__/*
    */venv/*
    */.venv/*
    */migrations/*
    */ui/*
    */papelera/*
branch = True

[coverage:report]
exclude_lines =
    # Líneas a excluir de cobertura
    pragma: no cover
    def __repr__
    def __str__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
    @abstractmethod
    @abc.abstractmethod
    class .*\bProtocol\):
    @overload

precision = 2
show_missing = True
skip_covered = False

[coverage:html]
directory = tests/coverage_html

# ═══════════════════════════════════════════════════════════════════════════════
# COMANDOS ÚTILES
# ═══════════════════════════════════════════════════════════════════════════════
#
# Tests rápidos (solo unit):
#   pytest -m unit
#
# Tests con LLM:
#   pytest -m llm
#
# Todos los tests:
#   pytest -m ""
#
# Tests de un módulo específico:
#   pytest tests/test_api_cases.py
#
# Tests con cobertura detallada:
#   pytest --cov-report=html
#
# Tests en paralelo (requiere pytest-xdist):
#   pytest -n auto
#
# ═══════════════════════════════════════════════════════════════════════════════

